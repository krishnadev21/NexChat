{% extends "chat/base.html" %} {% block content %}
<!-- Chat area -->
<div
  class="flex flex-col h-screen bg-[#0B141A]"
  id="chat-container"
  data-conversation-id="{{ conversation.id }}"
  data-user-id="{{ request.user.id }}"
  data-user-name="{{ request.user.username }}"
  data-user-avatar="{{ request.user.avatar.url }}"
  data-recipient-id="{{ conversation.partner.id }}"
  data-recipient-name="{{ conversation.partner.username }}"
  data-recipient-avatar="{{ conversation.partner.avatar.url }}"
>
  {% if conversation.partner %}
  <!-- Chat header -->
  <div
    class="p-3 border-b border-[#2F3B43] bg-[#202C33] flex justify-between items-center"
  >
    <div>
      <div class="flex items-center space-x-3">
        <!-- Back button -->
        <a
          href="{% url 'conversations-list' %}"
          class="text-white"
          title="Back"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"
            ></path>
          </svg>
        </a>

        <img
          src="{{ conversation.partner.avatar.url|default:'/media/default.jpg' }}"
          alt="{{ conversation.partner.username }}"
          class="w-10 h-10 rounded-full object-cover"
          onerror="this.src='/static/images/default-avatar.jpg'"
        />
        <div>
          <h2 class="font-medium text-[#E9EDEF]">
            {{ conversation.partner.username }}
          </h2>
          <p class="text-xs text-[#8696A0]">
            {{ conversation.partner.last_activity }}
          </p>
        </div>
      </div>
    </div>

    <!-- Clear chats Icon -->
    <a href="{% url 'delete-conversation' conversation.partner.id %}">
      <button class="text-[#fff] cursor-pointer" title="Clear chats">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="size-6"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"
          />
        </svg>
      </button>
    </a>
  </div>
  {% endif %}

  <!-- Messages container -->
  <div
    class="flex-1 overflow-y-auto p-4 space-y-2 bg-[#0B141A] bg-opacity-95"
    id="messages-container"
  >
    <!-- Messages will be inserted here -->
    {% for message in conversation.messages %}
    <!-- The starting point (flex-start) moves from left → right → to right → left.
         So your first item starts on the right side of the container. -->
     <div class="flex w-full gap-2 mb-3 {% if message.sender == request.user %}flex-row-reverse{% else %}justify-start{% endif %}">
        <!-- Avatar -->
        <img
          src="{{ message.sender.avatar.url|default:'/media/default.jpg' }}"
          alt="{{ message.sender.username }}"
          class="w-10 h-10 rounded-full object-cover flex-shrink-0"
          onerror="this.src='/static/images/default-avatar.jpg'"
        />

        <!-- Message bubble -->
        <div
          class="max-w-[65%] rounded-br-[30px] rounded-bl-[30px] p-3 {% if message.sender == request.user %}rounded-tl-[30px] bg-[#005C4B]{% else %}rounded-tr-[30px] bg-[#202C33]{% endif %} group relative"
        >
          <!-- Message content with hover actions -->
          <div class="relative">
            <p class="text-[#E9EDEF] pr-6">{{ message.body }}</p>

            <!-- Hover action buttons -->
            <div
              class="absolute right-0 top-0 opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex space-x-1 bg-[#00000066] rounded-lg p-1"
            >
              <!-- Edit Icon -->
              <button
                class="text-[#E9EDEF] hover:text-white p-1 cursor-pointer"
                title="Edit"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="size-6"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"
                  />
                </svg>
              </button>

              {% if message.sender == request.user %}
              <!-- Delete Icon -->
              <a href="{% url 'delete-message' message.id %}">
                <button
                  class="text-[#E9EDEF] hover:text-white p-1 cursor-pointer"
                  title="Delete"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="size-6"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"
                    />
                  </svg>
                </button>
              </a>
              {% endif %}

              <!-- Info Icon -->
              <button class="text-[#E9EDEF] hover:text-white p-1 cursor-pointer" title="Info">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="size-6"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z"
                  />
                </svg>
              </button>
            </div>
          </div>

          <!-- Timestamp and read receipts -->
          <p class="text-xs text-[#8696A0] text-right mt-1">
            {{ message.created_at|time:"H:i" }}
            {% if message.sender == request.user %} 
              {% if message.recipientId_has_read %}
                <span class="ml-1 text-[#53BDEB]">✓✓</span>
              {% else %}
                <span class="ml-1 text-gray-400">✓</span>
              {% endif %} 
            {% endif %}
          </p>
        </div>
      </div>
    {% empty %}
      <div class="text-center text-[#8696A0] py-8">No messages yet</div>
    {% endfor %}
  </div>

  <!-- Message input -->
  <div class="p-3 bg-[#202C33]">
    <form method="post" id="chat-form" class="flex items-center gap-2 w-full">
      {% csrf_token %}
      <div class="flex-1 min-w-0">
        <input
          type="text"
          name="body"
          id="body"
          placeholder="Type a message"
          class="w-full bg-[#2A3942] text-[#E9EDEF] rounded-full px-4 py-2 focus:outline-none focus:ring-1 focus:ring-[#00A884]"
          autocomplete="off"
          required
        />
      </div>
      <button
        type="submit"
        class="shrink-0 bg-[#00A884] text-white rounded-full p-2 hover:bg-[#06CF9C] focus:outline-none focus:ring-1 focus:ring-white cursor-pointer"
        aria-label="Send message"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="size-6"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"
          />
        </svg>
      </button>
    </form>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // DOM Elements
    const chatForm = document.getElementById("chat-form");
    const messagesContainer = document.getElementById("messages-container");
    const messageInput = document.getElementById("body");

    // Configuration Data
    const chatData = document.getElementById("chat-container").dataset;
    const userId = chatData.userId;
    const recipientAvatar = chatData.recipientAvatar;
    const recipientId = chatData.recipientId;
    const userAvatar = chatData.userAvatar;

    // Auto-scroll function
    const scrollToBottom = () => {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    };

    // Initial scroll to bottom when page loads
    scrollToBottom();

    // Web Socket Connection
    const chatSocket = new WebSocket(
      `ws://${window.location.host}/ws/socket-server/${recipientId}`
    );

    // Results: "5:45 pm", "11:30 am", "12:15 pm"
    function formatTime(timestamp) {
      return new Date(timestamp)
        .toLocaleTimeString("en-US", {
          hour: "numeric",
          minute: "2-digit",
          hour12: true,
        })
        .toLowerCase();
    }

    let typingTimeout;

    function sendTypingStatus(isTyping) {
      chatSocket.send(JSON.stringify({
        type: "typing",
        is_typing: isTyping
      }));
    }

    // Detect when user is typing
    messageInput.addEventListener("input", () => {
      sendTypingStatus(true);

      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        sendTypingStatus(false);
      }, 1500); // stop typing if idle for 1.5s
    });

    // Past the chatForm function
    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const messageInput = document.getElementById("body");
      const messageBody = messageInput.value.trim();

      if (!messageBody || !recipientId) return;

      try {
        chatSocket.send(JSON.stringify({ 
          type: "chat",
          message: messageBody
        }));
        messageInput.value = "";
      } catch (error) {
        console.error("Error:", error);
        // Show error notification
        showNotification(
          error.message || "Failed to send message",
          "bg-red-500"
        );
      }

      // Helper function to show notifications
      function showNotification(message, bgColor = "bg-blue-500") {
        const notification = document.createElement("div");
        notification.className = `fixed bottom-4 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg transition-opacity duration-300`;
        notification.textContent = message;
        document.body.appendChild(notification);

        // Auto-remove after 3 seconds
        setTimeout(() => {
          notification.style.opacity = "0";
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }
    });

    chatSocket.onmessage = (e) => {
      // Parse the received message
      const data = JSON.parse(e.data);

      if (data.type === "chat") {

        // Check if the message was sent by the current user
        const isCurrentUser = Number(userId) === Number(data.sender_id);

        // Optimistic UI update helpers
        const tempId = Date.now();
        const displayTime = formatTime(tempId);

        messagesContainer.innerHTML += `
          <div class="flex gap-2 mb-3 ${isCurrentUser ? "flex-row-reverse" : "justify-start"}" id="temp-${tempId}">
            <!-- Avatar -->
            <img
              src="${isCurrentUser ? userAvatar : recipientAvatar}" id="temp-${tempId}"
              alt="{{ message.sender.username }}"
              class="w-10 h-10 rounded-full object-cover flex-shrink-0"
              onerror="this.src='/static/images/default-avatar.jpg'"
            />

            <!-- Message Bubble -->
            <div class="max-w-[65%] rounded-br-[30px] rounded-bl-[30px] p-3
                ${isCurrentUser ? "rounded-tl-[30px] bg-[#005C4B]" : "rounded-tr-[30px] bg-[#202C33]"}">
                <p class="text-[#E9EDEF]">${data.message}</p>
                <p class="text-xs text-[#8696A0] text-right mt-1">${formatTime(tempId)}
                  ${isCurrentUser ? '<span class="ml-1">✓</span>' : "" } <!-- Only show check for own messages -->
                </p>
            </div>
          </div>
          `;

        // Scroll after new message is added
        scrollToBottom();
      }

      if (data.type === "typing") {
        console.log("printing");
      }
    };

    // Focus input when chat is opened
    if (document.getElementById("body")) {
      document.getElementById("body").focus();
    }
  });
</script>
{% endblock content %}
